---
@file: cert-manager-eks.yaml
@description: AWS EKS Cert Manageré…ç½®
@platform: AWS EKS
@version: v1.28
@certificate-manager: Cert Manager
---

# Cert Manager Configuration for AWS EKS

---

## ğŸ“‹ Description

æœ¬æ–‡ä»¶å®šä¹‰äº†YYCÂ³é¤é¥®å¹³å°åœ¨AWS EKSé›†ç¾¤ä¸Šçš„Cert Manageré…ç½®ã€‚

Cert Manageræ˜¯ä¸€ä¸ªKubernetesåŸç”Ÿçš„è¯ä¹¦ç®¡ç†å·¥å…·ï¼Œç”¨äºè‡ªåŠ¨è·å–ã€æ›´æ–°å’Œç®¡ç†TLSè¯ä¹¦ï¼ˆå¦‚Let's Encryptè¯ä¹¦ï¼‰ã€‚

---

## ğŸ“ Cert Manager Features

### 1. è¯ä¹¦ç®¡ç†

- **è‡ªåŠ¨è·å–TLSè¯ä¹¦**
- **è‡ªåŠ¨æ›´æ–°TLSè¯ä¹¦**
- **è‡ªåŠ¨ç»­ç­¾TLSè¯ä¹¦**

### 2. é›†æˆåŠŸèƒ½

- **Let's Encrypté›†æˆ**
- **ACMEåè®®æ”¯æŒ**
- **DNS ChallengeéªŒè¯**
- **HTTP ChallengeéªŒè¯**

---

## ğŸš€ Kubernetes Manifests

```yaml
# cert-manager-eks.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: cert-manager
  labels:
    name: cert-manager
    app: cert-manager
    project: yyc3-catering-platform
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: jetstack
  namespace: cert-manager
spec:
  interval: 1h
  url: https://charts.jetstack.io
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cert-manager
  namespace: cert-manager
spec:
  chart:
    spec:
      chart: cert-manager
      sourceRef:
        kind: HelmRepository
        name: jetstack
        namespace: cert-manager
      version: v1.14.0
  interval: 1h
  timeout: 5m
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    installCRDs: true
    replicaCount: 2
    extraArgs:
    - "--leader-elect"
    - "--dns01-recursive-nameservers-only"
    - "--dns01-recursive-nameservers=8.8.8.8:53,1.1.1.1:53"
    prometheus:
      enabled: true
      servicemonitor:
        enabled: true
        namespace: monitoring
        labels:
          app: cert-manager
    resources:
      requests:
        cpu: 100m
        memory: 100Mi
      limits:
        cpu: 500m
        memory: 500Mi
    podDnsPolicy: "None"
    podDnsConfig:
      nameservers:
      - 8.8.8.8
      - 1.1.1.1
```

---

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### 1. ä½¿ç”¨Helmå®‰è£…Cert Manager

```bash
# æ·»åŠ Cert Manager Helmä»“åº“
helm repo add jetstack https://charts.jetstack.io
helm repo update

# å®‰è£…Cert Manager
helm install cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --version v1.14.0 \
  --create-namespace \
  --set installCRDs=true \
  --set replicaCount=2 \
  --set extraArgs[0]="--leader-elect" \
  --set extraArgs[1]="--dns01-recursive-nameservers-only" \
  --set extraArgs[2]="--dns01-recursive-nameservers=8.8.8.8:53,1.1.1.1:53" \
  --set prometheus.enabled=true \
  --set prometheus.servicemonitor.enabled=true \
  --set prometheus.servicemonitor.namespace=monitoring \
  --set prometheus.servicemonitor.labels."app"=cert-manager \
  --set resources.requests.cpu=100m \
  --set resources.requests.memory=100Mi \
  --set resources.limits.cpu=500m \
  --set resources.limits.memory=500Mi \
  --set podDnsPolicy=None \
  --set podDnsConfig.nameservers[0]=8.8.8.8 \
  --set podDnsConfig.nameservers[1]=1.1.1.1
```

---

### 2. éªŒè¯Cert Managerå®‰è£…

```bash
# æŸ¥çœ‹Cert Manager Pod
kubectl get pods -n cert-manager -l app.kubernetes.io/name=cert-manager

# æŸ¥çœ‹Cert Manager CRDs
kubectl get crd | grep cert-manager

# æŸ¥çœ‹Cert ManagerçŠ¶æ€
kubectl get -n cert-manager deploy/cert-manager
```

---

### 3. é…ç½®Let's Encrypt Cluster Issuer

**æ­¥éª¤**ï¼š
1. åˆ›å»ºCluster Issuerèµ„æºï¼š
   ```yaml
   apiVersion: cert-manager.io/v1
   kind: ClusterIssuer
   metadata:
     name: letsencrypt-prod
   spec:
     acme:
       server: https://acme-v02.api.letsencrypt.org/directory
       email: admin@yyc3.com
       privateKeySecretRef:
         name: letsencrypt-prod
       solvers:
       - http01:
           ingress:
             class: nginx
   ```

2. åº”ç”¨Cluster Issuerï¼š
   ```bash
   kubectl apply -f clusterissuer-letsencrypt-prod.yaml
   ```

3. éªŒè¯Cluster Issuerï¼š
   ```bash
   kubectl describe clusterissuer letsencrypt-prod
   ```

---

### 4. åˆ›å»ºCertificateèµ„æº

**æ­¥éª¤**ï¼š
1. åˆ›å»ºCertificateèµ„æºï¼š
   ```yaml
   apiVersion: cert-manager.io/v1
   kind: Certificate
   metadata:
     name: yyc3-api-tls
     namespace: production
   spec:
     secretName: yyc3-api-tls
     dnsNames:
     - api.yyc3.com
     issuerRef:
       name: letsencrypt-prod
       kind: ClusterIssuer
   ```

2. åº”ç”¨Certificateèµ„æºï¼š
   ```bash
   kubectl apply -f certificate.yaml
   ```

3. éªŒè¯Certificateèµ„æºï¼š
   ```bash
   kubectl get certificate yyc3-api-tls -n production
   kubectl describe certificate yyc3-api-tls -n production
   ```

---

### 5. åœ¨Ingressä¸­ä½¿ç”¨Certificate

**æ­¥éª¤**ï¼š
1. åˆ›å»ºIngressèµ„æºï¼š
   ```yaml
   apiVersion: networking.k8s.io/v1
   kind: Ingress
   metadata:
     name: yyc3-api-ingress
     namespace: production
     annotations:
       kubernetes.io/ingress.class: nginx
       cert-manager.io/cluster-issuer: letsencrypt-prod
   spec:
     tls:
     - hosts:
       - api.yyc3.com
       secretName: yyc3-api-tls
     rules:
     - host: api.yyc3.com
       http:
         paths:
         - path: /
           pathType: Prefix
           backend:
             service:
               name: api-gateway
               port:
                 number: 8080
   ```

2. åº”ç”¨Ingressèµ„æºï¼š
   ```bash
   kubectl apply -f ingress.yaml
   ```

3. éªŒè¯Ingressèµ„æºï¼š
   ```bash
   kubectl get ingress yyc3-api-ingress -n production
   kubectl describe ingress yyc3-api-ingress -n production
   ```

---

## ğŸ“Š è¾“å‡ºä¸äº¤ä»˜ç‰©

| äº¤ä»˜ç‰© | å†…å®¹ |
|-------|------|
| Kubernetes Manifest | `cert-manager-eks.yaml` |
| Helm Chart | `jetstack/cert-manager` (v1.14.0) |
| Cluster Issuer | `letsencrypt-prod` |
| Certificate | `yyc3-api-tls` |

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: Cert Manager Podä¸€ç›´å¤„äº `Pending` æˆ– `CrashLoopBackOff` çŠ¶æ€æ€ä¹ˆåŠï¼Ÿ

**A**:
1. æ£€æŸ¥Podæ—¥å¿—ï¼š
   ```bash
   kubectl logs -n cert-manager -l app.kubernetes.io/name=cert-manager
   ```
2. æ£€æŸ¥NodeçŠ¶æ€ï¼š
   ```bash
   kubectl get nodes
   ```
3. æ£€æŸ¥DNSé…ç½®ï¼š
   ```yaml
   podDnsPolicy: "None"
   podDnsConfig:
     nameservers:
     - 8.8.8.8
     - 1.1.1.1
   ```

---

### Q2: Let's Encryptè¯ä¹¦è·å–å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**:
1. æ£€æŸ¥Cluster IssuerçŠ¶æ€ï¼š
   ```bash
   kubectl describe clusterissuer letsencrypt-prod
   ```
2. æ£€æŸ¥DNSè§£æï¼š
   ```bash
   nslookup api.yyc3.com
   ```
3. æ£€æŸ¥Ingressé…ç½®ï¼š
   ```bash
   kubectl describe ingress yyc3-api-ingress -n production
   ```
4. æ£€æŸ¥Certificateèµ„æºï¼š
   ```bash
   kubectl get certificate yyc3-api-tls -n production
   kubectl describe certificate yyc3-api-tls -n production
   ```

---

### Q3: å¦‚ä½•é…ç½®Let's Encrypt Stagingç¯å¢ƒï¼Ÿ

**A**:
1. åˆ›å»ºStaging Cluster Issuerï¼š
   ```yaml
   apiVersion: cert-manager.io/v1
   kind: ClusterIssuer
   metadata:
     name: letsencrypt-staging
   spec:
     acme:
       server: https://acme-staging-v02.api.letsencrypt.org/directory
       email: admin@yyc3.com
       privateKeySecretRef:
         name: letsencrypt-staging
       solvers:
       - http01:
           ingress:
             class: nginx
   ```

2. åœ¨Ingressä¸­ä½¿ç”¨Staging Cluster Issuerï¼š
   ```yaml
   annotations:
     cert-manager.io/cluster-issuer: letsencrypt-staging
   ```

**æ³¨æ„**ï¼šStagingç¯å¢ƒçš„è¯ä¹¦æœ‰æ•ˆæœŸè¾ƒçŸ­ï¼Œä¸”ä¸å—æµè§ˆå™¨ä¿¡ä»»ï¼Œä»…ç”¨äºæµ‹è¯•ã€‚

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [Cert Managerå®˜æ–¹æ–‡æ¡£](https://cert-manager.io/)
- [Let's Encryptæ–‡æ¡£](https://letsencrypt.org/)
- [ACMEåè®®æ–‡æ¡£](https://datatracker.ietf.org/wg/acme/documents/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2026-01-04
**ç»´æŠ¤äºº**: YYCÂ³ Infrastructure Team
