---
@file: cilium-eks.yaml
@description: AWS EKS Cilium ç½‘ç»œæ’ä»¶é…ç½®
@platform: AWS EKS
@version: v1.28
@network-plugin: Cilium
---

# Cilium Configuration for AWS EKS

---

## ğŸ“‹ Description

æœ¬æ–‡ä»¶å®šä¹‰äº†YYCÂ³é¤é¥®å¹³å°åœ¨AWS EKSé›†ç¾¤ä¸Šçš„Ciliumç½‘ç»œæ’ä»¶é…ç½®ã€‚

Ciliumæ˜¯ä¸€ä¸ªå¼€æºçš„ç½‘ç»œã€å¯è§‚æµ‹æ€§å’Œå®‰å…¨è§£å†³æ–¹æ¡ˆï¼Œå…·æœ‰eBPFï¼ˆextended Berkeley Packet Filterï¼‰æŠ€æœ¯ï¼Œé€‚ç”¨äºKubernetesç¯å¢ƒã€‚

---

## ğŸ“ Cilium Features

### 1. ç½‘ç»œåŠŸèƒ½

- **IPv4/IPv6åŒæ ˆæ”¯æŒ**
- **KubernetesåŸç”Ÿç½‘ç»œç­–ç•¥**
- **é€æ˜ä»£ç†ï¼ˆService Meshï¼‰**
- **ç½‘ç»œåŠ å¯†ï¼ˆIPsecã€WireGuardï¼‰**

### 2. å¯è§‚æµ‹æ€§åŠŸèƒ½

- **Hubbleï¼ˆç½‘ç»œå¯è§‚æµ‹æ€§ï¼‰**
- **Prometheusé›†æˆ**
- **Grafana Dashboard**
- **æµé‡è¿½è¸ª**

### 3. å®‰å…¨åŠŸèƒ½

- **ç½‘ç»œç­–ç•¥ï¼ˆNetwork Policyï¼‰**
- **ç«¯å£æ˜ å°„æ§åˆ¶**
- **Podå®‰å…¨ç­–ç•¥ï¼ˆPSPï¼‰**

---

## ğŸš€ Kubernetes Manifests

```yaml
# cilium-eks.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: kube-system
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: cilium
  namespace: kube-system
spec:
  chart: cilium
  repo: https://helm.cilium.io/
  version: 1.15.0
  targetNamespace: kube-system
  set:
    - name: cluster.name
      value: yyc3-production-eks
    - name: cluster.id
      value: 1
    - name: cluster.region
      value: us-east-1
    - name: kubeProxyReplacement
      value: "strict"
    - name: ipam.mode
      value: "kubernetes"
    - name: tunnel
      value: "vxlan"
    - name: ipv4.enabled
      value: "true"
    - name: ipv6.enabled
      value: "false"
    - name: hostServices.enabled
      value: "false"
    - name: routingMode
      value: "native"
    - name: masquerade
      value: "true"
    - name: hubble.enabled
      value: "true"
    - name: hubble.listenAddress
      value: ":4244"
    - name: hubble.relay.enabled
      value: "true"
    - name: hubble.ui.enabled
      value: "true"
    - name: hubble.ui.standalone.enabled
      value: "true"
    - name: hubble.ui.ingress.enabled
      value: "true"
    - name: prometheus.enabled
      value: "true"
    - name: operator.replicas
      value: 2
    - name: aws.enabled
      value: "true"
    - name: nodePort.enabled
      value: "false"
```

---

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### 1. ä½¿ç”¨Helmå®‰è£…Cilium

```bash
# æ·»åŠ Cilium Helmä»“åº“
helm repo add cilium https://helm.cilium.io/
helm repo update

# å®‰è£…Cilium
helm install cilium cilium/cilium \
  --namespace kube-system \
  --set cluster.name=yyc3-production-eks \
  --set cluster.id=1 \
  --set cluster.region=us-east-1 \
  --set kubeProxyReplacement=strict \
  --set ipam.mode=kubernetes \
  --set tunnel=vxlan \
  --set ipv4.enabled=true \
  --set ipv6.enabled=false \
  --set hostServices.enabled=false \
  --set routingMode=native \
  --set masquerade=true \
  --set hubble.enabled=true \
  --set hubble.relay.enabled=true \
  --set hubble.ui.enabled=true \
  --set hubble.ui.standalone.enabled=true \
  --set hubble.ui.ingress.enabled=true \
  --set prometheus.enabled=true \
  --set operator.replicas=2 \
  --set aws.enabled=true \
  --set nodePort.enabled=false
```

---

### 2. éªŒè¯Ciliumå®‰è£…

```bash
# æŸ¥çœ‹Cilium Pod
kubectl get pods -n kube-system -l app.kubernetes.io/name=cilium

# æŸ¥çœ‹CiliumçŠ¶æ€
cilium status

# æŸ¥çœ‹Hubble UI
cilium hubble ui
```

---

### 3. è®¿é—®Hubble UI

**æ­¥éª¤**ï¼š
1. å¯åŠ¨Hubble UIï¼š
   ```bash
   cilium hubble ui
   ```

2. æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® `http://localhost:12000`

---

### 4. é…ç½®Hubble Relayï¼ˆå¯é€‰ï¼‰

**ç›®çš„**ï¼šå…è®¸è¿œç¨‹å®¢æˆ·ç«¯è®¿é—®Hubble APIã€‚

**æ­¥éª¤**ï¼š
1. å¯ç”¨Hubble Relayï¼š
   ```bash
   kubectl port-forward -n kube-system svc/hubble-relay --address 0.0.0.0 4245:80
   ```

2. ä½¿ç”¨Hubble CLIè¿æ¥ï¼š
   ```bash
   hubble observe --server localhost:4245
   ```

---

## ğŸ“Š è¾“å‡ºä¸äº¤ä»˜ç‰©

| äº¤ä»˜ç‰© | å†…å®¹ |
|-------|------|
| Kubernetes Manifest | `cilium-eks.yaml` |
| Helm Chart | `cilium/cilium` (v1.15.0) |
| Hubble UI | `http://localhost:12000` |

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: Cilium Podä¸€ç›´å¤„äº `Pending` æˆ– `CrashLoopBackOff` çŠ¶æ€æ€ä¹ˆåŠï¼Ÿ

**A**:
1. æ£€æŸ¥Podæ—¥å¿—ï¼š
   ```bash
   kubectl logs -n kube-system -l app.kubernetes.io/name=cilium
   ```
2. æ£€æŸ¥NodeçŠ¶æ€ï¼š
   ```bash
   kubectl get nodes
   ```
3. æ£€æŸ¥Kernelç‰ˆæœ¬ï¼š
   ```bash
   uname -r
   ```
   **è¦æ±‚**: Kernel >= 4.9

---

### Q2: å¦‚ä½•é…ç½®ç½‘ç»œç­–ç•¥ï¼Ÿ

**A**:
1. åˆ›å»ºNetworkPolicyå¯¹è±¡ï¼š
   ```yaml
   apiVersion: networking.k8s.io/v1
   kind: NetworkPolicy
   metadata:
     name: allow-frontend-to-backend
     namespace: production
   spec:
     podSelector:
       matchLabels:
         app: backend
     policyTypes:
     - Ingress
     ingress:
     - from:
       - podSelector:
           matchLabels:
             app: frontend
       ports:
       - protocol: TCP
         port: 8080
   ```

2. åº”ç”¨NetworkPolicyï¼š
   ```bash
   kubectl apply -f networkpolicy.yaml
   ```

---

### Q3: å¦‚ä½•å¯ç”¨ç½‘ç»œåŠ å¯†ï¼Ÿ

**A**:
1. ä¿®æ”¹Helm Charté…ç½®ï¼š
   ```bash
   helm upgrade cilium cilium/cilium \
     --namespace kube-system \
     --set encryption.enabled=true \
     --set encryption.type=wireguard
   ```

2. éªŒè¯åŠ å¯†ï¼š
   ```bash
   cilium status
   ```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [Ciliumå®˜æ–¹æ–‡æ¡£](https://docs.cilium.io/)
- [Cilium GitHub](https://github.com/cilium/cilium)
- [AWS EKSæœ€ä½³å®è·µ](https://docs.aws.amazon.com/eks/latest/userguide/networking.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2026-01-04
**ç»´æŠ¤äºº**: YYCÂ³ Infrastructure Team
