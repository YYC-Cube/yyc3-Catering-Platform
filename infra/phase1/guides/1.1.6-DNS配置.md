# DNS配置手册 (CloudFlare)

**任务ID**: 1.1.6
**负责人**: 基础设施团队
**预计耗时**: 2小时
**截止日期**: 2026-01-05

---

## 一、任务概述

本任务的目标是在CloudFlare上配置DNS记录，将域名 `yyc3.com` 指向AWS ALB（生产环境API）和阿里云SLB（测试环境API），并设置TTL为60s以实现快速故障切换。

### 前置条件

- 已注册域名 `yyc3.com`（或计划注册）
- 已创建AWS ALB（生产环境）
- 已创建阿里云SLB（测试环境）
- 已注册CloudFlare账号

---

## 二、注册域名（如未注册）

**步骤**：
1. 访问 [CloudFlare官网](https://www.cloudflare.com)
2. 使用Root账户登录
3. 点击右上角 "Add a Site"
4. 输入域名：`yyc3.com`
5. 点击 "Add Site"
6. 选择计划：`Free`
7. 按照提示购买域名（如未注册）或添加现有域名
8. 配置域名服务器（Nameservers）
   - 将域名的Nameservers更改为CloudFlare提供的Nameservers（如：`abby.ns.cloudflare.com`, `don.ns.cloudflare.com`）

**检查清单**：
- [ ] 域名已注册
- [ ] 域名已添加到CloudFlare
- [ ] Nameservers已配置

---

## 三、配置DNS记录

### 3.1 配置API Gateway (AWS)

**步骤**：
1. 在CloudFlare控制台，选择域名 `yyc3.com`
2. 点击 "DNS" -> "Records"
3. 点击 "Add Record"
4. 输入以下信息：
   - Type: `CNAME`
   - Name: `api`
   - Target: `<AWS ALB DNS名称>` (如：`yyc3-api-1234567890.us-east-1.elb.amazonaws.com`)
   - Proxy status: `DNS only` (如果使用ACM，可以选择 `Proxied`；如果使用Let's Encrypt，必须选择 `DNS only`)
   - TTL: `Auto` (或 `3600`)
5. 点击 "Save"

**检查清单**：
- [ ] CNAME记录 `api.yyc3.com` 已创建
- [ ] 指向AWS ALB

---

### 3.2 配置API Gateway (阿里云 - 测试环境)

**步骤**：
1. 在CloudFlare控制台，选择域名 `yyc3.com`
2. 点击 "DNS" -> "Records"
3. 点击 "Add Record"
4. 输入以下信息：
   - Type: `CNAME`
   - Name: `staging-api`
   - Target: `<阿里云SLB DNS名称>` (如：`yyc3-staging-api.cn-hangzhou.alb.aliyuncs.com`)
   - Proxy status: `DNS only`
   - TTL: `Auto` (或 `3600`)
5. 点击 "Save"

**检查清单**：
- [ ] CNAME记录 `staging-api.yyc3.com` 已创建
- [ ] 指向阿里云SLB

---

### 3.3 配置K8s Master (AWS)

**步骤**：
1. 在CloudFlare控制台，选择域名 `yyc3.com`
2. 点击 "DNS" -> "Records"
3. 点击 "Add Record"
4. 输入以下信息：
   - Type: `A`
   - Name: `k8s-master`
   - IPv4 address: `<AWS K8s Master节点公网IP>` (如：`52.90.123.45`)
   - Proxy status: `DNS only`
   - TTL: `Auto` (或 `3600`)
5. 点击 "Save"

**检查清单**：
- [ ] A记录 `k8s-master.yyc3.com` 已创建
- [ ] 指向AWS K8s Master节点公网IP

---

### 3.4 配置K8s Worker (阿里云)

**步骤**：
1. 在CloudFlare控制台，选择域名 `yyc3.com`
2. 点击 "DNS" -> "Records"
3. 点击 "Add Record"
4. 输入以下信息：
   - Type: `A`
   - Name: `k8s-worker`
   - IPv4 address: `<阿里云K8s Worker节点公网IP>` (如：`47.96.123.45`)
   - Proxy status: `DNS only`
   - TTL: `Auto` (或 `3600`)
5. 点击 "Save"

**检查清单**：
- [ ] A记录 `k8s-worker.yyc3.com` 已创建
- [ ] 指向阿里云K8s Worker节点公网IP

---

## 四、配置TTL

### 4.1 修改TTL为60s

**目的**：实现快速故障切换，当主节点（AWS）故障时，DNS能够在60秒内切换到备用节点（阿里云）。

**步骤**：
1. 在CloudFlare控制台，选择域名 `yyc3.com`
2. 点击 "DNS" -> "Records"
3. 找到记录 `api.yyc3.com`
4. 点击记录右侧的编辑图标（铅笔）
5. 将TTL从 `Auto` (通常为 `3600`) 改为 `60`
6. 点击 "Save"
7. 对其他记录（如 `staging-api.yyc3.com`）重复上述步骤

**注意**：
- CloudFlare的最低TTL为 `Auto`，但可以根据实际情况调整。
- 如果使用CloudFlare的负载均衡（Load Balancer），可以使用 "Failover" 策略，无需手动修改TTL。

**检查清单**：
- [ ] TTL已设置为60s（或接近的值）

---

## 五、验证DNS解析

### 5.1 验证API Gateway (AWS)

**命令**：
```bash
nslookup api.yyc3.com
# 或
dig api.yyc3.com
```

**预期输出**：
```
Server:  127.0.0.1
Address: 127.0.0.1#53

Non-authoritative answer:
api.yyc3.com	canonical name = yyc3-api-1234567890.us-east-1.elb.amazonaws.com.
Name:	yyc3-api-1234567890.us-east-1.elb.amazonaws.com
Address: 52.90.123.45
```

---

### 5.2 验证API Gateway (阿里云 - 测试环境)

**命令**：
```bash
nslookup staging-api.yyc3.com
# 或
dig staging-api.yyc3.com
```

**预期输出**：
```
Server:  127.0.0.1
Address: 127.0.0.1#53

Non-authoritative answer:
staging-api.yyc3.com	canonical name = yyc3-staging-api.cn-hangzhou.alb.aliyuncs.com.
Name:	yyc3-staging-api.cn-hangzhou.alb.aliyuncs.com
Address: 47.96.123.45
```

---

### 5.3 验证K8s Master (AWS)

**命令**：
```bash
nslookup k8s-master.yyc3.com
# 或
dig k8s-master.yyc3.com
```

**预期输出**：
```
Server:  127.0.0.1
Address: 127.0.0.1#53

Non-authoritative answer:
Name:	k8s-master.yyc3.com
Address: 52.90.123.45
```

---

### 5.4 验证K8s Worker (阿里云)

**命令**：
```bash
nslookup k8s-worker.yyc3.com
# 或
dig k8s-worker.yyc3.com
```

**预期输出**：
```
Server:  127.0.0.1
Address: 127.0.0.1#53

Non-authoritative answer:
Name:	k8s-worker.yyc3.com
Address: 47.96.123.45
```

---

## 六、常见问题

### Q1: DNS解析一直返回旧IP怎么办？

**A**：
1. 清除本地DNS缓存：
   - macOS: `sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder`
   - Windows: `ipconfig /flushdns`
   - Linux: `sudo systemd-resolve --flush-caches`
2. 使用在线DNS检查工具（如：[DNSChecker](https://www.dnschecker.org/)）
3. 等待DNS传播（通常需要几分钟到几小时）

---

### Q2: 如何实现快速故障切换？

**A**：
1. 配置TTL为较小的值（如60s）
2. 使用CloudFlare的负载均衡（Load Balancer）功能，配置 "Failover" 策略
3. 监控主节点的健康状态，当主节点故障时，自动切换到备用节点

---

### Q3: 为什么不能使用CloudFlare的代理（Proxied）？

**A**：
- 如果使用Let's Encrypt申请证书，必须使用 `DNS only`，因为Let's Encrypt需要直接验证域名所有权。
- 如果使用ACM（AWS Certificate Manager），可以使用 `Proxied`，利用CloudFlare的CDN和WAF功能。

---

## 七、输出与交付物

| 交付物 | 内容 |
|-------|------|
| 域名 | `yyc3.com` |
| CNAME记录 | `api.yyc3.com` -> AWS ALB |
| CNAME记录 | `staging-api.yyc3.com` -> 阿里云SLB |
| A记录 | `k8s-master.yyc3.com` -> AWS K8s Master |
| A记录 | `k8s-worker.yyc3.com` -> 阿里云K8s Worker |
| TTL | `60s` |

---

## 八、参考文档

- [CloudFlare DNS文档](https://developers.cloudflare.com/dns/)
- [AWS Route 53文档](https://docs.aws.amazon.com/route53/)
- [阿里云DNS文档](https://help.aliyun.com/product/29697.html)

---

**文档版本**: v1.0.0
**最后更新**: 2026-01-04
**维护人**: YYC³ Infrastructure Team
