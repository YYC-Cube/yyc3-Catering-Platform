# Kubernetes集群联邦配置手册

**任务ID**: 1.2.7
**负责人**: 容器平台团队
**预计耗时**: 1天
**截止日期**: 2026-01-10

---

## 一、任务概述

本任务的目标是在AWS EKS、阿里云ACK、腾讯云TKE三个集群之间建立联邦（Federation），实现跨集群的服务发现、调度和统一管理。

### 前置条件

- 已完成任务 1.2.6（节点1.2任务执行准备）
- 三个Kubernetes集群（EKS, ACK, TKE）均已部署并处于 `Active` 状态
- 各集群的 `kubeconfig` 已配置好
- 已安装 `kubectl` (v1.28+)
- 已安装 `kubefedctl` (KubeFed v2 CLI工具)

---

## 二、联邦架构选择

### 2.1 方案：Kubernetes Federation (KubeFed v2)

**选择理由**：
- 成熟的开源项目，支持多云
- 独立于特定云厂商
- 支持跨集群的Service (ServiceReplicaSet)、ConfigMap等资源分发

**架构图**：
```
Host Cluster (AWS EKS)               Member Clusters
+------------------+               +------------------+
|  KubeFed Control |               |                  |
|     Plane         | <-----------> |  Aliyun ACK      |
|  (Federation)    |               +------------------+
+------------------+                        |
       |                                 |
       | <------------------------------->+
       |
       | <-------------------------------+
       |
       v
+------------------+
|   Tencent TKE    |
+------------------+
```

---

## 三、执行流程

### 3.1 安装 KubeFed 工具

**步骤**：

1. 下载 `kubefedctl` 二进制文件：
   ```bash
   wget https://github.com/kubernetes-sigs/kubefed/releases/download/v0.9.0/kubefedctl-v0.9.0-darwin-amd64.tgz
   tar -xvf kubefedctl-v0.9.0-darwin-amd64.tgz
   chmod +x kubefedctl
   sudo mv kubefedctl /usr/local/bin/
   ```

2. 验证安装：
   ```bash
   kubefedctl version
   ```

---

### 3.2 初始化联邦

**步骤**：

1. 选择 Host Cluster（主控集群）：
   - 建议选择 **AWS EKS** 作为 Host Cluster，因为其地理位置居中且稳定性高。

2. 初始化联邦：
   ```bash
   kubectl config use-context aws-eks-context
   kubefedctl init \
     --name=yyc3-federation \
     --namespace=kube-federation-system \
     --host-cluster-context=aws-eks-context
   ```

3. 验证 Pod 运行：
   ```bash
   kubectl get pods -n kube-federation-system
   ```

**预期结果**：
- 看到 `kubefed-controller-manager` 等Pod处于 `Running` 状态。

---

### 3.3 注册成员集群

**步骤**：

1. 注册 Aliyun ACK：
   ```bash
   kubefedctl join \
     --name=aliyun-ack \
     --namespace=kube-federation-system \
     --cluster-context=aliyun-ack-context \
     --host-cluster-context=aws-eks-context
   ```

2. 注册 Tencent TKE：
   ```bash
   kubefedctl join \
     --name=tencent-tke \
     --namespace=kube-federation-system \
     --cluster-context=tencent-tke-context \
     --host-cluster-context=aws-eks-context
   ```

3. 验证集群注册：
   ```bash
   kubectl get kubefedclusters -n kube-federation-system
   ```

**预期结果**：
- 输出包含 `aliyun-ack` 和 `tencent-tke`，状态为 `Ready`。

---

### 3.4 配置跨集群网络

由于各集群位于不同VPC，必须通过VPN或专线打通网络。

**验证步骤**：

1. 在 EKS Cluster 中创建一个测试 Pod，尝试 ping ACK Cluster 的 Pod IP。
   ```bash
   kubectl config use-context aws-eks-context
   kubectl run test-pod --image=busybox --rm -it --restart=Never -- nslookup <ack-service>.<namespace>.svc.cluster.local
   ```

2. 如果解析失败，检查VPN连接和VPC Peering配置（参考 `1.1.5-跨云VPN连接.md`）。

---

### 3.5 创建联邦资源示例

**步骤**：

1. 在 Host Cluster (EKS) 上定义一个联邦类型（FederatedType）。KubeFed 自带常见的资源类型，也可使用 CRD 扩展。

2. 示例：创建一个联邦 Service (FederatedService)：
   ```yaml
   apiVersion: types.kubefed.io/v1beta1
   kind: FederatedService
   metadata:
     name: api-gateway
     namespace: production
   spec:
     template:
       spec:
         selector:
           app: api-gateway
         ports:
           - port: 8080
   placement:
     clusters:
       - name: aliyun-ack
       - name: tencent-tke
   overrides:
     - clusterName: aliyun-ack
       clusterOverrides:
         - path: "/spec/ports/0/port"
           value: 8081 # 可以为不同集群设置不同配置
   ```

3. 应用配置：
   ```bash
   kubectl apply -f federated-service.yaml
   ```

4. 验证：
   ```bash
   # 在 EKS 查看
   kubectl get svc api-gateway -n production

   # 切换到 ACK 查看
   kubectl config use-context aliyun-ack-context
   kubectl get svc api-gateway -n production

   # 切换到 TKE 查看
   kubectl config use-context tencent-tke-context
   kubectl get svc api-gateway -n production
   ```

**预期效果**：
- Service 在三个集群中均已创建。

---

## 四、故障排查

### Q1: `kubefedctl join` 失败？

**A**:
1. 检查 Host Cluster 的 API Server 是否可访问。
2. 检查 Member Cluster 的 `kubeconfig` 是否正确。
3. 检查网络连通性（VPN/Peering）。

---

### Q2: 资源没有同步到成员集群？

**A**:
1. 检查 `kubefed-controller-manager` 的日志：
   ```bash
   kubectl logs -n kube-federation-system -l app=kubefed-controller-manager -f
   ```
2. 检查 `Federated[Resource]` 中的 `placement` 配置，确保包含了目标集群名称。

---

## 五、输出与交付物

| 交付物 | 内容 |
|-------|------|
| KubeFed Control Plane | 部署在 AWS EKS (Namespace: kube-federation-system) |
| 成员集群列表 | aliyun-ack, tencent-tke |
| 联邦网络 | 跨VPC/VPN已打通并验证 |
| 测试资源 | FederatedService 示例 |

---

## 六、参考文档

- [KubeFed 官方文档](https://kubefed.io/)
- [多集群管理指南](https://kubernetes.io/docs/tasks/administer-cluster/federation/)
- [跨云VPN连接手册](/guides/1.1.5-跨云VPN连接.md)

---

**文档版本**: v1.0.0
**最后更新**: 2026-01-10
**维护人**: YYC³ Infrastructure Team
