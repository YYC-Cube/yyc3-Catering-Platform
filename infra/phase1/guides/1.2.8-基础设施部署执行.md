# 基础设施部署执行计划

**任务ID**: 1.2.8
**负责人**: 基础设施团队
**预计耗时**: 1天
**截止日期**: 2026-01-11

---

## 一、任务概述

本任务的目标是使用 Terraform 在 AWS、阿里云、腾讯云上执行基础设施代码，创建 VPC、网络安全组、Kubernetes 集群（EKS, ACK, TKE）及相关资源。

### 前置条件

- 已完成任务 1.2.6（节点1.2任务执行准备）
- 已完成云账号配置（AWS, Aliyun, Tencent）
- Terraform (v1.6+) 已安装
- AWS CLI, Aliyun CLI, Tencent CLI 已安装并配置好凭证
- 已安装 kubectl (v1.28+)

---

## 二、部署策略

### 2.1 部署顺序

遵循 **"核心优先，逐步推进"** 的原则：

1. **AWS (Primary)**：首先部署 AWS EKS 集群，作为主控集群（Host Cluster）。
2. **Aliyun (Secondary)**：部署阿里云 ACK 集群。
3. **Tencent (Secondary)**：部署腾讯云 TKE 集群。

### 2.2 并行执行

虽然顺序不能乱，但可以安排不同的人员在不同终端并行执行，前提是处理好依赖关系（例如 AWS 完成前，不要开始集群联邦配置）。

---

## 三、AWS EKS 部署步骤

### 3.1 Terraform 初始化

**目录**: `terraform/aws/`

```bash
cd /Users/my/Downloads/yyc3-catering-platform/infra/phase1/iac/terraform/aws

# 初始化（下载Provider插件）
terraform init

# 验证配置
terraform validate

# 查看变更计划（重要！）
terraform plan -out=tfplan
```

### 3.2 申请变更

```bash
# 应用变更（预计耗时：15-20分钟）
terraform apply tfplan
```

**输出示例**：
```
aws_vpc.main: Creating...
aws_internet_gateway.igw: Creating...
aws_eks_cluster.main: Still creating... [10s elapsed]
...
Apply complete! Resources: X added, 0 changed, 0 destroyed.
```

### 3.3 验证部署

1. **验证 EKS 集群状态**：
   ```bash
   aws eks describe-cluster --name yyc3-production --query 'cluster.status'
   ```
   **预期**: `"ACTIVE"`

2. **配置 kubectl**：
   ```bash
   aws eks update-kubeconfig --name yyc3-production --region us-east-1
   ```

3. **验证节点连接**：
   ```bash
   kubectl get nodes
   ```
   **预期**: 看到 3 个节点，状态为 `Ready`。

---

## 四、阿里云 ACK 部署步骤

### 4.1 Terraform 初始化

**目录**: `terraform/aliyun/`

```bash
cd /Users/my/Downloads/yyc3-catering-platform/infra/phase1/iac/terraform/aliyun

# 初始化
terraform init

# 验证
terraform validate

# 计划
terraform plan -out=tfplan
```

### 4.2 申请变更

```bash
# 应用变更（预计耗时：20-30分钟）
terraform apply tfplan
```

### 4.3 验证部署

1. **验证 ACK 集群状态**：
   ```bash
   aliyun cs GET /clusters/<集群ID> | jq -r '.state'
   ```
   **预期**: `"running"`

2. **配置 kubectl**：
   ```bash
   # 获取 KubeConfig
   aliyun cs GET /k8s/<集群ID>/user_config | jq -r '.config' > ~/.kube/config-aliyun
   export KUBECONFIG=~/.kube/config-aliyun
   ```

3. **验证节点连接**：
   ```bash
   kubectl get nodes
   ```
   **预期**: 看到 3 个节点，状态为 `Ready`。

---

## 五、腾讯云 TKE 部署步骤

### 5.1 Terraform 初始化

**目录**: `terraform/tencent/`

```bash
cd /Users/my/Downloads/yyc3-catering-platform/infra/phase1/iac/terraform/tencent

# 初始化
terraform init

# 验证
terraform validate

# 计划
terraform plan -out=tfplan
```

### 5.2 申请变更

```bash
# 应用变更（预计耗时：20-30分钟）
terraform apply tfplan
```

### 5.3 验证部署

1. **验证 TKE 集群状态**：
   ```bash
   tccli tke DescribeCluster --ClusterId <集群ID> | jq -r '.ClusterStatus'
   ```
   **预期**: `"Running"`

2. **配置 kubectl**：
   ```bash
   # 获取 KubeConfig
   tccli tke DescribeClusterKubeconfig --ClusterId <集群ID> | jq -r '.Kubeconfig' > ~/.kube/config-tencent
   export KUBECONFIG=~/.kube/config-tencent
   ```

3. **验证节点连接**：
   ```bash
   kubectl get nodes
   ```
   **预期**: 看到 3 个节点，状态为 `Ready`。

---

## 六、回滚计划

如果在部署过程中出现错误，请立即执行回滚：

1. **查看 Terraform State**：
   ```bash
   terraform show
   ```

2. **撤销变更（Destructive）**：
   ```bash
   terraform destroy
   ```
   *注意：这将删除该云厂商下所有由 Terraform 管理的资源。*

3. **修正问题后重新部署**：
   - 修正代码或网络配置
   - 重新执行 `terraform init` -> `plan` -> `apply`

---

## 七、环境变量与安全

在执行前，请确保以下环境变量已配置正确，并且不要在 `main.tf` 中硬编码密钥：

| 云厂商 | 环境变量 | 示例 |
|-------|---------|------|
| AWS | `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` | `export AWS_ACCESS_KEY_ID=AKIA...` |
| Aliyun | `ALICLOUD_ACCESS_KEY`, `ALICLOUD_SECRET_KEY`, `ALICLOUD_REGION` | `export ALICLOUD_ACCESS_KEY=LTIA...` |
| Tencent | `TENCENTCLOUD_SECRET_ID`, `TENCENTCLOUD_SECRET_KEY` | `export TENCENTCLOUD_SECRET_ID=AKID...` |

---

## 八、输出与交付物

| 交付物 | 内容 |
|-------|------|
| AWS EKS Cluster | `yyc3-production` (us-east-1) |
| AWS VPC | 10.0.0.0/16 |
| Aliyun ACK Cluster | `yyc3-production` (cn-hangzhou) |
| Aliyun VPC | 172.16.0.0/16 |
| Tencent TKE Cluster | `yyc3-production` (ap-guangzhou) |
| Tencent VPC | 192.168.0.0/16 |
| KubeConfigs | 3个文件的本地配置 |

---

## 九、常见问题

### Q1: Terraform Init 失败，报错网络问题？

**A**:
- 检查是否开启了代理，并配置 `HTTP_PROXY`, `HTTPS_PROXY` 环境变量。
- 检查 DNS 解析是否正常。

### Q2: EKS 集群一直处于 `Creating` 状态？

**A**:
- 等待时间可能需要 20 分钟，请耐心等待。
- 检查 AWS 账号配额（Service Quotas）是否足够。

### Q3: kubectl 无法连接集群（certificate expired）？

**A**:
- 重新执行 `update-kubeconfig` 或 `DescribeClusterKubeconfig` 命令获取最新的证书。

---

## 十、后续步骤

一旦基础设施部署完成且验证通过：

1. **执行节点1.2.7**：开始集群联邦配置（KubeFed）。
2. **部署基础组件**：安装 Cilium、NGINX Ingress、Cert Manager（参考 `kubernetes/eks/`, `ack/`, `tke/` 目录下的配置）。
3. **部署应用**：使用 Helm 部署 Parent Chart (`helm/charts/yyc3-catering-platform/`)。

---

**文档版本**: v1.0.0
**最后更新**: 2026-01-10
**维护人**: YYC³ Infrastructure Team
