# CDN配置手册 (AWS CloudFront & 阿里云CDN)

**任务ID**: 1.1.7
**负责人**: 基础设施团队
**预计耗时**: 2小时
**截止日期**: 2026-01-05

---

## 一、任务概述

本任务的目标是配置AWS CloudFront和阿里云CDN，用于加速静态资源（图片、视频、CSS、JS）的访问，降低延迟。

### 静态资源来源

- **AWS S3 Bucket**: `yyc3-static-assets` (主源)
- **阿里云OSS Bucket**: `yyc3-backup` (备源)

---

## 二、AWS CloudFront配置

### 2.1 创建Web Distribution

**步骤**：
1. 登录 [AWS CloudFront控制台](https://console.aws.amazon.com/cloudfront/)
2. 点击 "Create Distribution"
3. 点击 "Get Started" (Web)
4. 输入以下信息：

   **Origin Settings**:
   - Origin Domain Name: `yyc3-static-assets.s3.amazonaws.com` (或从S3 Bucket设置中复制)
   - Origin ID: `yyc3-s3-origin`
   - S3 Bucket Access: `Yes use OAI` (Bucket Policy: `yyc3-cloudfront-oai`)

   **Default Cache Behavior Settings**:
   - Viewer Protocol Policy: `Redirect HTTP to HTTPS`
   - Allowed HTTP Methods: `GET, HEAD` (如需要上传，可以选择 `GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE`)
   - Cached HTTP Methods: `GET, HEAD`
   - Compress Objects Automatically: `Yes`
   - Cache TTL: `86400` (1天)

   **Distribution Settings**:
   - Price Class: `Use Only US, Canada and Europe` (或根据业务选择)
   - Alternate Domain Names (CNAMEs): `cdn.yyc3.com`
   - Custom SSL Certificate: 选择之前创建的ACM证书（`*.yyc3.com`）
   - Default Root Object: `index.html`
   - Logging: `On` (S3 Bucket: `yyc3-logs`)
   - IPv6: `On`
   - Comment: `YYC³餐饮平台 - CDN Distribution`

5. 点击 "Create Distribution"

**检查清单**：
- [ ] CloudFront Distribution已创建
- [ ] 状态：`In Progress` -> `Deployed` (通常需要15-30分钟)

---

### 2.2 配置S3 Bucket Policy

**步骤**：
1. 登录 [AWS S3控制台](https://console.aws.amazon.com/s3/)
2. 找到Bucket `yyc3-static-assets`
3. 点击 "Permissions"
4. 点击 "Bucket Policy"
5. 输入以下策略：
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "AllowCloudFrontOAI",
         "Effect": "Allow",
         "Principal": {
           "AWS": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity <OAI-ID>"
         },
         "Action": "s3:GetObject",
         "Resource": "arn:aws:s3:::yyc3-static-assets/*"
       }
     ]
   }
   ```
6. 点击 "Save"

**注意**：
- `<OAI-ID>` 需要替换为实际的OAI ID，可以在CloudFront控制台的 "Origin Settings" 中查看。

---

### 2.3 配置DNS (CNAME)

**步骤**：
1. 登录 [CloudFlare控制台](https://dash.cloudflare.com/)
2. 选择域名 `yyc3.com`
3. 点击 "DNS" -> "Records"
4. 点击 "Add Record"
5. 输入以下信息：
   - Type: `CNAME`
   - Name: `cdn`
   - Target: `<CloudFront Distribution Domain Name>` (如：`d1234567890.cloudfront.net`)
   - Proxy status: `DNS only` (如果使用ACM，可以选择 `Proxied`)
   - TTL: `Auto`
6. 点击 "Save"

**检查清单**：
- [ ] CNAME记录 `cdn.yyc3.com` 已创建
- [ ] 指向CloudFront Distribution

---

## 三、阿里云CDN配置

### 3.1 添加域名

**步骤**：
1. 登录 [阿里云CDN控制台](https://cdn.console.aliyun.com)
2. 点击 "域名管理" -> "添加域名"
3. 输入以下信息：
   - 业务类型：`图片小文件` (或根据业务选择)
   - 加速域名：`cdn-backup.yyc3.com` (注意：阿里云CDN域名需要备案)
   - 资源分组：`default`
   - 加速区域：`中国大陆境外` (或根据业务选择)
   - 源站信息：
     - 源站类型：`OSS`
     - 域名：`yyc3-backup.oss-cn-hangzhou.aliyuncs.com`
   - 加速区域：`全球`
4. 点击 "下一步"

**注意**：
- 如果域名 `cdn-backup.yyc3.com` 需要备案，请确保备案已完成。
- 如果备案未完成，可以使用 `cdn-backup.yyc3.com` 作为测试域名。

---

### 3.2 配置CNAME

**步骤**：
1. 在阿里云CDN控制台，点击 "域名管理"
2. 找到域名 `cdn-backup.yyc3.com`
3. 点击 "配置"
4. 找到 "CNAME"
5. 复制CNAME记录（如：`cdn-backup.yyc3.com.w.kunlunslb.com`）
6. 登录 [CloudFlare控制台](https://dash.cloudflare.com/)
7. 选择域名 `yyc3.com`
8. 点击 "DNS" -> "Records"
9. 点击 "Add Record"
10. 输入以下信息：
    - Type: `CNAME`
    - Name: `cdn-backup`
    - Target: `<阿里云CDN CNAME>`
    - Proxy status: `DNS only`
    - TTL: `Auto`
11. 点击 "Save"

**检查清单**：
- [ ] CNAME记录 `cdn-backup.yyc3.com` 已创建
- [ ] 指向阿里云CDN

---

### 3.3 配置缓存策略

**步骤**：
1. 在阿里云CDN控制台，点击 "域名管理"
2. 找到域名 `cdn-backup.yyc3.com`
3. 点击 "配置"
4. 找到 "缓存配置"
5. 点击 "修改"
6. 输入以下信息：
   - 类型：`目录`
   - 目录：`/`
   - 过期时间：`31536000` (1年)
   - 权重：`10`
7. 点击 "确定"

---

### 3.4 配置HTTPS

**步骤**：
1. 在阿里云CDN控制台，点击 "域名管理"
2. 找到域名 `cdn-backup.yyc3.com`
3. 点击 "配置"
4. 找到 "HTTPS配置"
5. 点击 "修改"
6. 输入以下信息：
   - HTTPS状态：`开启`
   - 证书来源：`云盾证书` (或手动上传)
   - 证书：选择之前创建的证书（`*.yyc3.com`）
   - 私钥：选择对应的私钥
   - 强制HTTPS跳转：`开启`
   - HTTP2.0：`开启`
7. 点击 "确定"

---

## 四、验证与测试

### 4.1 验证AWS CloudFront

**步骤**：
1. 打开浏览器
2. 访问：`https://cdn.yyc3.com/test.jpg`
3. 查看响应头：
   - `x-amz-cf-id`: `<CloudFront ID>`
   - `x-cache`: `Hit from cloudfront` (或 `Miss from cloudfront`)

**预期效果**：
- 图片可以正常访问
- 响应延迟显著降低（通常< 100ms）

---

### 4.2 验证阿里云CDN

**步骤**：
1. 打开浏览器
2. 访问：`https://cdn-backup.yyc3.com/test-backup.jpg`
3. 查看响应头：
   - `Via`: `CDN Cache Server`

**预期效果**：
- 图片可以正常访问
- 响应延迟显著降低（通常< 100ms）

---

## 五、常见问题

### Q1: CloudFront一直显示 `In Progress` 怎么办？

**A**：
1. 等待15-30分钟
2. 检查S3 Bucket Policy是否正确
3. 检查CNAME记录是否正确

---

### Q2: 阿里云CDN提示域名未备案怎么办？

**A**：
1. 使用 `cdn-backup.yyc3.com` 作为测试域名（如果备案未完成）
2. 完成域名备案
3. 将 `cdn.yyc3.com` 切换到阿里云CDN（如果需要）

---

### Q3: 如何配置CDN的故障切换？

**A**：
1. 使用CloudFlare的负载均衡（Load Balancer）功能
2. 配置源为 `cdn.yyc3.com` (AWS) 和 `cdn-backup.yyc3.com` (阿里云)
3. 配置健康检查（Health Check）
4. 当主源故障时，自动切换到备用源

---

## 六、输出与交付物

| 交付物 | 内容 |
|-------|------|
| AWS CloudFront Distribution | `yyc3-cloudfront-distribution` |
| AWS CloudFront Domain Name | `d1234567890.cloudfront.net` |
| 阿里云CDN域名 | `cdn-backup.yyc3.com` |
| CNAME记录 | `cdn.yyc3.com` -> CloudFront |
| CNAME记录 | `cdn-backup.yyc3.com` -> 阿里云CDN |

---

## 七、参考文档

- [AWS CloudFront文档](https://docs.aws.amazon.com/cloudfront/)
- [阿里云CDN文档](https://help.aliyun.com/product/26630.html)
- [CloudFlare CDN文档](https://developers.cloudflare.com/cache/)

---

**文档版本**: v1.0.0
**最后更新**: 2026-01-04
**维护人**: YYC³ Infrastructure Team
