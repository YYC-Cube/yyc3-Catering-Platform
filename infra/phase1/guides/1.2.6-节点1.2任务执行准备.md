# 节点1.2任务执行准备手册

**任务ID**: 1.2.6
**负责人**: 基础设施团队 & 容器平台团队
**预计耗时**: 1天
**截止日期**: 2026-01-08

---

## 一、任务概述

本任务的目标是在AWS、阿里云、腾讯云上部署Kubernetes集群（EKS, ACK, TKE），并配置基础组件（Cilium, NGINX Ingress, Cert Manager）。

### 前置条件

- 已完成任务 1.1（多云账号与网络配置）
- 已完成任务 1.2.3 - 1.2.5（Kubernetes配置创建）
- 已安装Terraform (v1.6+), AWS CLI, 阿里云CLI, 腾讯云CLI, kubectl (v1.28+), helm (v3.12+)

---

## 二、执行流程

### 2.1 流程图

```
AWS EKS                                  阿里云ACK                                 腾讯云TKE
-------                                  ----------                                 --------
1. Terraform apply                         1. Terraform apply                         1. Terraform apply
   - VPC                                      - VPC                                      - VPC
   - EKS Cluster                             - ACK Cluster                             - TKE Cluster
   - IAM Role                                - RAM Role                                - CAM Role
   - Worker Nodes                            - Worker Nodes                             - Worker Nodes
2. kubectl config                            2. kubectl config                            2. kubectl config
3. Helm install Cilium                       3. Helm install Cilium                       3. Helm install Cilium
4. Helm install NGINX Ingress                4. Helm install NGINX Ingress                4. Helm install NGINX Ingress
5. Helm install Cert Manager                 5. Helm install Cert Manager                 5. Helm install Cert Manager
6. Verify                                   6. Verify                                   6. Verify
```

---

## 三、AWS EKS执行步骤

### 3.1 部署基础设施

**步骤**：
1. 进入AWS Terraform目录：
   ```bash
   cd /Users/my/Downloads/yyc3-catering-platform/infra/phase1/iac/terraform/aws
   ```

2. 初始化Terraform：
   ```bash
   terraform init
   ```

3. 规划变更：
   ```bash
   terraform plan -out=tfplan
   ```

4. 应用变更（预计耗时：15-20分钟）：
   ```bash
   terraform apply tfplan
   ```

5. 等待EKS集群状态变为 `ACTIVE`：
   ```bash
   aws eks describe-cluster --name yyc3-production --query 'cluster.status'
   ```

---

### 3.2 配置kubectl

**步骤**：
1. 更新kubeconfig：
   ```bash
   aws eks update-kubeconfig --name yyc3-production --region us-east-1
   ```

2. 验证连接：
   ```bash
   kubectl get nodes
   kubectl get pods --all-namespaces
   ```

---

### 3.3 安装基础组件

**步骤**：
1. 添加Helm仓库：
   ```bash
   helm repo add cilium https://helm.cilium.io/
   helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx/
   helm repo add jetstack https://charts.jetstack.io/
   helm repo update
   ```

2. 安装Cilium：
   ```bash
   helm install cilium cilium/cilium \
     --namespace kube-system \
     --set cluster.name=yyc3-production-eks \
     --set cluster.id=1 \
     --set cluster.region=us-east-1 \
     --set kubeProxyReplacement=strict \
     --set ipam.mode=kubernetes \
     --set tunnel=vxlan \
     --set ipv4.enabled=true \
     --set ipv6.enabled=false \
     --set hostServices.enabled=false \
     --set routingMode=native \
     --set masquerade=true \
     --set hubble.enabled=true \
     --set prometheus.enabled=true \
     --set operator.replicas=2 \
     --set aws.enabled=true
   ```

3. 安装NGINX Ingress Controller：
   ```bash
   helm install ingress-nginx ingress-nginx/ingress-nginx \
     --namespace ingress-nginx \
     --set controller.replicaCount=2 \
     --set controller.service.annotations.service\.beta\.kubernetes\.io/aws-load-balancer-type="nlb" \
     --set controller.service.annotations.service\.beta\.kubernetes\.io/aws-load-balancer-cross-zone-load-balancing-enabled="true" \
     --set controller.service.annotations.service\.beta\.kubernetes\.io/aws-load-balancer-scheme="internet-facing" \
     --set controller.metrics.enabled=true
   ```

4. 安装Cert Manager：
   ```bash
   helm install cert-manager jetstack/cert-manager \
     --namespace cert-manager \
     --set installCRDs=true \
     --set replicaCount=2 \
     --set prometheus.enabled=true
   ```

---

### 3.4 验证部署

**步骤**：
1. 查看Cilium状态：
   ```bash
   kubectl get pods -n kube-system -l app.kubernetes.io/name=cilium
   ```

2. 查看NGINX Ingress Controller状态：
   ```bash
   kubectl get pods -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
   kubectl get svc -n ingress-nginx ingress-nginx-controller
   ```

3. 查看Cert Manager状态：
   ```bash
   kubectl get pods -n cert-manager -l app.kubernetes.io/name=cert-manager
   ```

**预期效果**：
- 所有Pod状态为 `Running`
- NGINX Ingress Controller Service类型为 `LoadBalancer`，并分配了外部IP（NLB DNS）

---

## 四、阿里云ACK执行步骤

### 4.1 部署基础设施

**步骤**：
1. 进入阿里云Terraform目录：
   ```bash
   cd /Users/my/Downloads/yyc3-catering-platform/infra/phase1/iac/terraform/aliyun
   ```

2. 初始化Terraform：
   ```bash
   terraform init
   ```

3. 规划变更：
   ```bash
   terraform plan -out=tfplan
   ```

4. 应用变更（预计耗时：20-30分钟）：
   ```bash
   terraform apply tfplan
   ```

5. 等待ACK集群状态变为 `running`：
   ```bash
   aliyun cs GET /clusters/<集群ID>
   ```

---

### 4.2 配置kubectl

**步骤**：
1. 配置kubeconfig：
   ```bash
   aliyun cs GET /k8s/<集群ID>/user_config | jq -r '.config' > ~/.kube/config-aliyun
   export KUBECONFIG=~/.kube/config-aliyun
   ```

2. 验证连接：
   ```bash
   kubectl get nodes
   kubectl get pods --all-namespaces
   ```

---

### 4.3 安装基础组件

**步骤**：
1. 添加Helm仓库：
   ```bash
   helm repo add cilium https://helm.cilium.io/
   helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx/
   helm repo add jetstack https://charts.jetstack.io/
   helm repo update
   ```

2. 安装Cilium：
   ```bash
   helm install cilium cilium/cilium \
     --namespace kube-system \
     --set cluster.name=yyc3-production-ack \
     --set cluster.id=2 \
     --set cluster.region=cn-hangzhou \
     --set kubeProxyReplacement=strict \
     --set ipam.mode=kubernetes \
     --set tunnel=vxlan \
     --set ipv4.enabled=true \
     --set ipv6.enabled=false \
     --set hostServices.enabled=false \
     --set routingMode=native \
     --set masquerade=true \
     --set hubble.enabled=true \
     --set prometheus.enabled=true \
     --set operator.replicas=2 \
     --set alicloud.enabled=true
   ```

3. 安装NGINX Ingress Controller：
   ```bash
   helm install ingress-nginx ingress-nginx/ingress-nginx \
     --namespace ingress-nginx \
     --set controller.replicaCount=2 \
     --set controller.service.annotations.service\.beta\.kubernetes\.io/alibaba-cloud-loadbalancer-spec="slb.s3.small" \
     --set controller.service.annotations.service\.beta\.kubernetes\.io/alibaba-cloud-loadbalancer-address-type="internet" \
     --set controller.service.annotations.service\.beta\.kubernetes\.io/alibaba-cloud-loadbalancer-charge-type="paybytraffic" \
     --set controller.service.annotations.service\.beta\.kubernetes\.io/alibaba-cloud-loadbalancer-protocol-port="https:443" \
     --set controller.metrics.enabled=true
   ```

4. 安装Cert Manager：
   ```bash
   helm install cert-manager jetstack/cert-manager \
     --namespace cert-manager \
     --set installCRDs=true \
     --set replicaCount=2 \
     --set prometheus.enabled=true
   ```

---

### 4.4 验证部署

**步骤**：
1. 查看Cilium状态：
   ```bash
   kubectl get pods -n kube-system -l app.kubernetes.io/name=cilium
   ```

2. 查看NGINX Ingress Controller状态：
   ```bash
   kubectl get pods -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
   kubectl get svc -n ingress-nginx ingress-nginx-controller
   ```

3. 查看Cert Manager状态：
   ```bash
   kubectl get pods -n cert-manager -l app.kubernetes.io/name=cert-manager
   ```

**预期效果**：
- 所有Pod状态为 `Running`
- NGINX Ingress Controller Service类型为 `LoadBalancer`，并分配了外部IP（SLB IP）

---

## 五、腾讯云TKE执行步骤

### 5.1 部署基础设施

**步骤**：
1. 进入腾讯云Terraform目录：
   ```bash
   cd /Users/my/Downloads/yyc3-catering-platform/infra/phase1/iac/terraform/tencent
   ```

2. 初始化Terraform：
   ```bash
   terraform init
   ```

3. 规划变更：
   ```bash
   terraform plan -out=tfplan
   ```

4. 应用变更（预计耗时：20-30分钟）：
   ```bash
   terraform apply tfplan
   ```

5. 等待TKE集群状态变为 `Running`：
   ```bash
   tccli tke DescribeCluster --ClusterId <集群ID>
   ```

---

### 5.2 配置kubectl

**步骤**：
1. 配置kubeconfig：
   ```bash
   tccli tke DescribeClusterKubeconfig --ClusterId <集群ID> | jq -r '.Kubeconfig' > ~/.kube/config-tencent
   export KUBECONFIG=~/.kube/config-tencent
   ```

2. 验证连接：
   ```bash
   kubectl get nodes
   kubectl get pods --all-namespaces
   ```

---

### 5.3 安装基础组件

**步骤**：
1. 添加Helm仓库：
   ```bash
   helm repo add cilium https://helm.cilium.io/
   helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx/
   helm repo add jetstack https://charts.jetstack.io/
   helm repo update
   ```

2. 安装Cilium：
   ```bash
   helm install cilium cilium/cilium \
     --namespace kube-system \
     --set cluster.name=yyc3-production-tke \
     --set cluster.id=3 \
     --set cluster.region=ap-guangzhou \
     --set kubeProxyReplacement=strict \
     --set ipam.mode=kubernetes \
     --set tunnel=vxlan \
     --set ipv4.enabled=true \
     --set ipv6.enabled=false \
     --set hostServices.enabled=false \
     --set routingMode=native \
     --set masquerade=true \
     --set hubble.enabled=true \
     --set prometheus.enabled=true \
     --set operator.replicas=2 \
     --set tencentcloud.enabled=true
   ```

3. 安装NGINX Ingress Controller：
   ```bash
   helm install ingress-nginx ingress-nginx/ingress-nginx \
     --namespace ingress-nginx \
     --set controller.replicaCount=2 \
     --set controller.service.annotations.service\.kubernetes\.io/qcloud-loadbalancer-type="PUBLIC" \
     --set controller.service.annotations.service\.kubernetes\.io/qcloud-loadbalancer-protocol-port="http:80,https:443" \
     --set controller.metrics.enabled=true
   ```

4. 安装Cert Manager：
   ```bash
   helm install cert-manager jetstack/cert-manager \
     --namespace cert-manager \
     --set installCRDs=true \
     --set replicaCount=2 \
     --set prometheus.enabled=true
   ```

---

### 5.4 验证部署

**步骤**：
1. 查看Cilium状态：
   ```bash
   kubectl get pods -n kube-system -l app.kubernetes.io/name=cilium
   ```

2. 查看NGINX Ingress Controller状态：
   ```bash
   kubectl get pods -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
   kubectl get svc -n ingress-nginx ingress-nginx-controller
   ```

3. 查看Cert Manager状态：
   ```bash
   kubectl get pods -n cert-manager -l app.kubernetes.io/name=cert-manager
   ```

**预期效果**：
- 所有Pod状态为 `Running`
- NGINX Ingress Controller Service类型为 `LoadBalancer`，并分配了外部IP（公网IP）

---

## 六、输出与交付物

| 交付物 | 内容 |
|-------|------|
| AWS EKS Cluster | `yyc3-production` |
| AWS NLB | `yyc3-ingress-1234567890.elb.us-east-1.amazonaws.com` |
| 阿里云ACK Cluster | `yyc3-production` |
| 阿里云SLB | `47.96.123.45` |
| 腾讯云TKE Cluster | `yyc3-production` |
| 腾讯云CLB | `123.45.67.89` |
| Cilium | 3个集群已安装 |
| NGINX Ingress Controller | 3个集群已安装 |
| Cert Manager | 3个集群已安装 |

---

## 七、常见问题

### Q1: Terraform apply失败怎么办？

**A**:
1. 检查错误日志：
   ```bash
   terraform show
   ```
2. 检查权限（IAM/RAM/CAM）
3. 检查配额（Quotas）
4. 检查网络配置（VPC, Subnet, Security Groups）

---

### Q2: kubectl连接失败怎么办？

**A**:
1. 检查kubeconfig：
   ```bash
   cat ~/.kube/config
   ```
2. 检查集群状态：
   - AWS: `aws eks describe-cluster`
   - 阿里云: `aliyun cs GET /clusters`
   - 腾讯云: `tccli tke DescribeCluster`
3. 检查网络连接（VPN）

---

### Q3: Helm安装失败怎么办？

**A**:
1. 检查Helm版本：
   ```bash
   helm version
   ```
2. 检查Helm仓库：
   ```bash
   helm repo update
   ```
3. 检查Kubernetes集群状态：
   ```bash
   kubectl get nodes
   ```

---

## 八、参考文档

- [Terraform文档](https://www.terraform.io/docs)
- [AWS EKS文档](https://docs.aws.amazon.com/eks/)
- [阿里云ACK文档](https://help.aliyun.com/product/85942.html)
- [腾讯云TKE文档](https://cloud.tencent.com/document/product/457)

---

**文档版本**: v1.0.0
**最后更新**: 2026-01-06
**维护人**: YYC³ Infrastructure Team
