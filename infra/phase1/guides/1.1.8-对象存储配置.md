# 对象存储配置手册 (AWS S3 & 阿里云OSS)

**任务ID**: 1.1.8
**负责人**: 基础设施团队
**预计耗时**: 2小时
**截止日期**: 2026-01-05

---

## 一、任务概述

本任务的目标是在AWS和阿里云上配置对象存储，用于存储静态资源（图片、视频、CSS、JS）和备份数据库。同时，开启跨区域复制（Replication）和数据生命周期管理（Lifecycle）。

### 存储需求

| 用途 | 云服务商 | Bucket名称 | 区域 | 访问权限 |
|-----|---------|-----------|------|---------|
| 静态资产（主） | AWS S3 | `yyc3-static-assets` | us-east-1 | Public Read |
| 静态资产（备） | 阿里云OSS | `yyc3-static-assets-backup` | cn-hangzhou | Private |
| 日志存储 | AWS S3 | `yyc3-logs` | us-east-1 | Private |
| 数据库备份 | 阿里云OSS | `yyc3-db-backup` | cn-hangzhou | Private |

---

## 二、AWS S3配置

### 2.1 创建S3 Bucket（静态资产）

**步骤**：
1. 登录 [AWS S3控制台](https://console.aws.amazon.com/s3/)
2. 点击 "Create bucket"
3. 输入以下信息：
   - Bucket name: `yyc3-static-assets` (必须全局唯一)
   - Region: `us-east-1`
4. 点击 "Create bucket"

---

### 2.2 配置S3 Bucket权限（静态资产）

**步骤**：
1. 在S3控制台，找到Bucket `yyc3-static-assets`
2. 点击 "Permissions"
3. 在 "Block public access (bucket settings)" 部分，点击 "Edit"
4. 取消勾选 "Block all public access"
5. 点击 "Save changes" (输入 `confirm` 确认)
6. 在 "Access control list (ACL)" 部分，点击 "Edit"
7. 在 "Everyone (public access)" 部分，勾选 "List" 和 "Read"
8. 点击 "Save changes"

**检查清单**：
- [ ] S3 Bucket已创建
- [ ] 已配置Public Read权限

---

### 2.3 配置静态网站托管（可选）

**步骤**：
1. 在S3控制台，找到Bucket `yyc3-static-assets`
2. 点击 "Properties"
3. 在 "Static website hosting" 部分，点击 "Edit"
4. 选择 "Enable"
5. 输入以下信息：
   - Index document: `index.html`
   - Error document: `404.html`
6. 点击 "Save changes"
7. 记录 "Bucket website endpoint" (如：`http://yyc3-static-assets.s3-website-us-east-1.amazonaws.com`)

**检查清单**：
- [ ] 静态网站托管已启用

---

### 2.4 配置生命周期管理

**目的**：自动删除旧版本的静态资源，节省存储成本。

**步骤**：
1. 在S3控制台，找到Bucket `yyc3-static-assets`
2. 点击 "Management" -> "Lifecycle rules"
3. 点击 "Create lifecycle rule"
4. 输入以下信息：
   - Rule name: `delete-old-versions`
   - Rule scope: `Apply to all objects in the bucket`
5. 点击 "Next"
6. 在 "Expiration" 部分，选择 "Expire current versions of objects" -> `After` -> `90 days`
7. 点击 "Next"
8. 在 "Noncurrent versions" 部分，选择 "Expire noncurrent versions of objects" -> `After` -> `30 days`
9. 点击 "Next"
10. 点击 "Create rule"

**检查清单**：
- [ ] 生命周期规则已创建
- [ ] 当前版本90天后过期
- [ ] 非当前版本30天后过期

---

### 2.5 配置跨区域复制（CRR）

**目的**：将AWS S3 Bucket的数据自动复制到阿里云OSS Bucket。

**步骤**：
1. 在S3控制台，找到Bucket `yyc3-static-assets`
2. 点击 "Management" -> "Replication"
3. 点击 "Create replication rule"
4. 输入以下信息：
   - Rule name: `replicate-to-aliyun`
   - Source bucket: `yyc3-static-assets`
   - Destination bucket: `<阿里云OSS Bucket名称>` (需要先配置跨云同步服务，这里仅做示例)
5. 点击 "Save"

**注意**：
- AWS S3原生不支持直接复制到阿里云OSS。
- 需要使用第三方同步工具（如 `rclone`, `s3cmd`）或服务（如 `AWS Transfer Family`）。
- 建议使用定时任务（Cron Job）进行增量同步。

**检查清单**：
- [ ] 跨区域复制规则已创建（或配置了定时同步任务）

---

### 2.6 创建S3 Bucket（日志存储）

**步骤**：
1. 在S3控制台，点击 "Create bucket"
2. 输入以下信息：
   - Bucket name: `yyc3-logs`
   - Region: `us-east-1`
3. 点击 "Create bucket"

---

### 2.7 配置生命周期管理（日志存储）

**目的**：自动删除30天前的日志文件。

**步骤**：
1. 在S3控制台，找到Bucket `yyc3-logs`
2. 点击 "Management" -> "Lifecycle rules"
3. 点击 "Create lifecycle rule"
4. 输入以下信息：
   - Rule name: `delete-old-logs`
   - Rule scope: `Apply to all objects in the bucket`
5. 点击 "Next"
6. 在 "Expiration" 部分，选择 "Expire current versions of objects" -> `After` -> `30 days`
7. 点击 "Next"
8. 点击 "Create rule"

**检查清单**：
- [ ] 生命周期规则已创建
- [ ] 日志文件30天后过期

---

## 三、阿里云OSS配置

### 3.1 创建OSS Bucket（静态资产备份）

**步骤**：
1. 登录 [阿里云OSS控制台](https://oss.console.aliyun.com/)
2. 点击 "创建Bucket"
3. 输入以下信息：
   - Bucket名称: `yyc3-static-assets-backup` (必须全局唯一)
   - 地域: `华东1（杭州）`
   - 存储类型: `标准存储`
   - 访问权限: `私有`
   - 读写权限: `私有`
4. 点击 "确定"

---

### 3.2 配置生命周期管理（静态资产备份）

**步骤**：
1. 在OSS控制台，找到Bucket `yyc3-static-assets-backup`
2. 点击 "基础设置" -> "生命周期"
3. 点击 "创建规则"
4. 输入以下信息：
   - 规则名称: `delete-old-versions`
   - 状态: `开启`
   - 应用范围: `整个Bucket`
5. 在 "过期删除" 部分，勾选 "启用过期删除"
   - 过期天数: `90` (天)
6. 在 "删除过期标记" 部分，勾选 "自动删除过期的删除标记"
   - 过期天数: `7` (天)
7. 在 "版本过期" 部分，勾选 "启用"
   - 过期天数: `30` (天)
8. 点击 "确定"

**检查清单**：
- [ ] 生命周期规则已创建
- [ ] 当前版本90天后过期
- [ ] 非当前版本30天后过期

---

### 3.3 创建OSS Bucket（数据库备份）

**步骤**：
1. 在OSS控制台，点击 "创建Bucket"
2. 输入以下信息：
   - Bucket名称: `yyc3-db-backup`
   - 地域: `华东1（杭州）`
   - 存储类型: `低频访问存储` (节省成本)
   - 访问权限: `私有`
   - 读写权限: `私有`
3. 点击 "确定"

---

### 3.4 配置生命周期管理（数据库备份）

**目的**：将30天前的数据库备份自动转为归档存储，180天后过期。

**步骤**：
1. 在OSS控制台，找到Bucket `yyc3-db-backup`
2. 点击 "基础设置" -> "生命周期"
3. 点击 "创建规则"
4. 输入以下信息：
   - 规则名称: `archive-and-expire-db-backup`
   - 状态: `开启`
   - 应用范围: `整个Bucket`
5. 在 "过期删除" 部分，勾选 "启用过期删除"
   - 过期天数: `180` (天)
6. 在 "转换存储类型" 部分，勾选 "启用转换存储类型"
   - 修改时间超过 `30` 天时，转换为 `归档存储`
7. 点击 "确定"

**检查清单**：
- [ ] 生命周期规则已创建
- [ ] 30天后转为归档存储
- [ ] 180天后过期

---

### 3.5 配置跨区域复制（CRR）

**目的**：将阿里云OSS Bucket的数据自动复制到另一个区域的OSS Bucket（如 `ap-guangzhou`）。

**步骤**：
1. 在OSS控制台，找到Bucket `yyc3-db-backup`
2. 点击 "数据管理" -> "跨区域复制"
3. 点击 "设置"
4. 输入以下信息：
   - 复制规则名称: `replicate-to-guangzhou`
   - 状态: `开启`
   - 目标Bucket: `<广州区域的OSS Bucket名称>` (需要提前创建)
   - 目标Bucket地域: `华南1（广州）`
5. 点击 "确定"

**注意**：
- 如果不使用跨区域复制，可以使用定时任务（Cron Job）进行增量备份。

**检查清单**：
- [ ] 跨区域复制规则已创建（或配置了定时备份任务）

---

## 四、配置跨云同步

### 4.1 使用rclone进行同步

**目的**：将AWS S3 Bucket的数据同步到阿里云OSS Bucket。

**步骤**：
1. 安装rclone：
   ```bash
   # macOS
   brew install rclone

   # Linux
   curl https://rclone.org/install.sh | sudo bash
   ```

2. 配置AWS S3：
   ```bash
   rclone config
   ```
   - Name: `aws-s3`
   - Type: `s3`
   - Provider: `AWS`
   - Access Key ID: `<AWS Access Key ID>`
   - Secret Access Key: `<AWS Secret Access Key>`
   - Region: `us-east-1`
   - Location constraint: `us-east-1`
   - ACL: `private`

3. 配置阿里云OSS：
   ```bash
   rclone config
   ```
   - Name: `aliyun-oss`
   - Type: `s3`
   - Provider: `Alibaba`
   - Access Key ID: `<阿里云AccessKey ID>`
   - Secret Access Key: `<阿里云AccessKey Secret>`
   - Endpoint: `https://oss-cn-hangzhou.aliyuncs.com`
   - ACL: `private`

4. 运行同步命令：
   ```bash
   # 单向同步（AWS -> 阿里云）
   rclone sync aws-s3:yyc3-static-assets aliyun-oss:yyc3-static-assets-backup

   # 每天凌晨2点自动同步（Cron Job）
   0 2 * * * rclone sync aws-s3:yyc3-static-assets aliyun-oss:yyc3-static-assets-backup >> /var/log/rclone-sync.log 2>&1
   ```

**检查清单**：
- [ ] rclone已安装
- [ ] AWS S3已配置
- [ ] 阿里云OSS已配置
- [ ] 同步命令已测试
- [ ] Cron Job已配置

---

## 五、验证与测试

### 5.1 验证AWS S3（静态资产）

**步骤**：
1. 上传测试文件到AWS S3 Bucket `yyc3-static-assets`：
   ```bash
   aws s3 cp test.jpg s3://yyc3-static-assets/
   ```

2. 访问测试文件：
   ```
   https://yyc3-static-assets.s3.amazonaws.com/test.jpg
   ```

**预期效果**：
- 图片可以正常访问

---

### 5.2 验证阿里云OSS（静态资产备份）

**步骤**：
1. 等待rclone同步完成（或手动触发）
2. 检查阿里云OSS Bucket `yyc3-static-assets-backup` 是否包含 `test.jpg`

**预期效果**：
- 文件已同步到阿里云OSS

---

### 5.3 验证生命周期管理

**步骤**：
1. 上传一个测试文件，并设置 `x-amz-expiration` 为30天后：
   ```bash
   aws s3 cp test-expired.jpg s3://yyc3-static-assets/
   ```

2. 30天后（或手动修改生命周期规则为1分钟后），检查文件是否被自动删除。

**预期效果**：
- 文件已自动删除

---

## 六、常见问题

### Q1: 如何降低S3/OSS的存储成本？

**A**：
1. 使用生命周期管理，将旧文件转为低频访问存储或归档存储。
2. 启用版本控制，但设置非当前版本的生命周期（如30天后过期）。
3. 使用跨区域复制（CRR）实现异地容灾，但选择低成本的备份区域。

---

### Q2: 如何加速S3/OSS的访问？

**A**：
1. 使用CDN（AWS CloudFront、阿里云CDN）加速静态资源访问。
2. 使用边缘计算（如AWS CloudFront Functions、阿里云EdgeRoutine）优化请求处理。
3. 使用HTTP/3协议降低延迟。

---

## 七、输出与交付物

| 交付物 | 内容 |
|-------|------|
| AWS S3 Bucket | `yyc3-static-assets` (静态资产) |
| AWS S3 Bucket | `yyc3-logs` (日志存储) |
| 阿里云OSS Bucket | `yyc3-static-assets-backup` (静态资产备份) |
| 阿里云OSS Bucket | `yyc3-db-backup` (数据库备份) |
| 跨云同步工具 | `rclone` (已配置) |
| Cron Job | `0 2 * * * rclone sync ...` (每天凌晨2点同步) |

---

## 八、参考文档

- [AWS S3文档](https://docs.aws.amazon.com/s3/)
- [阿里云OSS文档](https://help.aliyun.com/product/31815.html)
- [rclone文档](https://rclone.org/)

---

**文档版本**: v1.0.0
**最后更新**: 2026-01-04
**维护人**: YYC³ Infrastructure Team
