# 跨云VPN连接手册 (AWS <-> 阿里云)

**任务ID**: 1.1.5
**负责人**: 基础设施团队
**预计耗时**: 5天
**截止日期**: 2026-01-07

---

## 一、任务概述

本任务的目标是在AWS和阿里云之间建立Site-to-Site VPN连接，实现跨云网络互通。
- **AWS VPC**: 10.0.0.0/16
- **阿里云VPC**: 172.16.0.0/16
- **预期延迟**: < 100ms

### 前置条件

- 已完成任务 1.1.1（AWS账号配置）
- 已完成任务 1.1.2（阿里云账号配置）
- 已创建AWS VPC（10.0.0.0/16）
- 已创建阿里云VPC（172.16.0.0/16）

---

## 二、配置流程

### 2.1 流程图

```
AWS 端                                      阿里云端
-------                                      --------
1. 创建 Customer Gateway                      1. 创建 VPN 网关
2. 创建 Virtual Private Gateway                2. 创建 用户网关
3. 创建 Site-to-Site VPN Connection             3. 创建 IPsec 连接
4. 配置路由表                                   4. 配置路由表
5. 下载 VPN 配置文件                            5. 下载 VPN 配置文件
6. 配置 IPsec 参数                               6. 配置 IPsec 参数
```

---

## 三、AWS端配置

### 3.1 创建Customer Gateway

**步骤**：
1. 登录 [AWS VPC控制台](https://console.aws.amazon.com/vpc/)
2. 在左侧导航栏，点击 "Customer Gateways"
3. 点击 "Create customer gateway"
4. 输入以下信息：
   - Name tag: `yyc3-aliyun-cg`
   - Routing: `Dynamic` (BGP)
   - IP address: `<阿里云VPN网关公网IP>` (待创建后获取)
   - BGP ASN: `65000`
5. 点击 "Create customer gateway"

**注意**：由于阿里云VPN网关尚未创建，此处可以先使用一个占位符IP，待阿里云VPN网关创建后，再修改Customer Gateway的IP地址。

---

### 3.2 创建Virtual Private Gateway (VGW)

**步骤**：
1. 在AWS VPC控制台，点击 "Virtual Private Gateways"
2. 点击 "Create virtual private gateway"
3. 输入以下信息：
   - Name tag: `yyc3-vgw`
   - ASN: `64512`
4. 点击 "Create virtual private gateway"
5. 在VGW列表中，点击 "Actions" -> "Attach to VPC"
6. 选择VPC：`yyc3-production-vpc` (10.0.0.0/16)
7. 点击 "Attach"

---

### 3.3 创建Site-to-Site VPN Connection

**步骤**：
1. 在AWS VPC控制台，点击 "Site-to-Site VPN Connections"
2. 点击 "Create VPN connection"
3. 输入以下信息：
   - Name tag: `yyc3-aliyun-vpn`
   - Target gateway type: `Customer Gateway`
   - Customer gateway: `yyc3-aliyun-cg`
   - Virtual private gateway: `yyc3-vgw`
   - Routing options: `Dynamic (requires BGP)`
4. 点击 "Create VPN connection"

**注意**：VPN连接的状态会显示为 "Pending"，直到阿里云端的配置完成。

---

### 3.4 配置路由表

**步骤**：
1. 在AWS VPC控制台，点击 "Route Tables"
2. 找到VPC `yyc3-production-vpc` 的主路由表
3. 点击 "Route propagation" 标签
4. 点击 "Edit route propagation"
5. 勾选 `yyc3-vgw`
6. 点击 "Save changes"

**效果**：AWS路由表将自动学习到阿里云VPC的路由。

---

## 四、阿里云端配置

### 4.1 创建VPN网关

**步骤**：
1. 登录 [阿里云VPC控制台](https://vpc.console.aliyun.com/vpc)
2. 在左侧导航栏，点击 "VPN网关"
3. 点击 "创建VPN网关"
4. 选择地域：`华东1（杭州）`
5. 输入以下信息：
   - 名称：`yyc3-vpn-gateway`
   - VPC：`yyc3-production-vpc` (172.16.0.0/16)
   - 网关类型：`标准型`
   - SSL连接数：`5`
   - 带宽规格：`5Mbps`
6. 点击 "立即购买"
7. 点击 "立即开通"
8. 等待VPN网关创建完成（约2-5分钟）
9. 记录VPN网关的**公网IP**（如：47.96.123.45）

---

### 4.2 创建用户网关

**步骤**：
1. 在阿里云VPC控制台，点击 "VPN网关"
2. 切换到 "用户网关" 标签
3. 点击 "创建用户网关"
4. 输入以下信息：
   - 名称：`yyc3-aws-cg`
   - 公网IP：`<AWS VPN网关公网IP>` (待创建后获取)
   - ASN：`64512`
5. 点击 "确定"

**注意**：由于AWS VPN网关尚未创建（或刚创建，IP地址尚未分配），此处可以先使用一个占位符IP，待AWS VGW创建后，再修改用户网关的IP地址。

---

### 4.3 创建IPsec连接

**步骤**：
1. 在阿里云VPC控制台，点击 "VPN网关"
2. 找到VPN网关 `yyc3-vpn-gateway`
3. 点击 "管理"
4. 点击 "IPsec连接" -> "创建IPsec连接"
5. 输入以下信息：
   - 名称：`yyc3-aws-ipsec`
   - 用户网关：`yyc3-aws-cg`
   - 路由方式：`感兴趣流` (推荐) 或 `目的路由`
   - 预共享密钥：`<设置强密码>` (如：`YourSuperSecretP@ssw0rd123!`)
6. 点击 "立即购买"
7. 点击 "立即开通"

---

### 4.4 配置路由表

**步骤**：
1. 在阿里云VPC控制台，点击 "路由表"
2. 找到VPC `yyc3-production-vpc` 的主路由表
3. 点击 "路由条目" -> "添加路由条目"
4. 输入以下信息：
   - 目标网段：`10.0.0.0/16` (AWS VPC)
   - 下一跳类型：`VPN网关`
   - VPN网关：`yyc3-vpn-gateway`
5. 点击 "确定"

---

## 五、配置验证与故障排查

### 5.1 验证VPN连接

**AWS端**：
1. 在AWS VPC控制台，点击 "Site-to-Site VPN Connections"
2. 找到VPN连接 `yyc3-aliyun-vpn`
3. 查看状态：
   - Tunnel 1: `UP`
   - Tunnel 2: `UP`

**阿里云端**：
1. 在阿里云VPC控制台，点击 "VPN网关"
2. 找到IPsec连接 `yyc3-aws-ipsec`
3. 查看状态：
   - IPsec连接状态：`第二阶段协商成功`

---

### 5.2 Ping测试

**AWS EC2 Instance (10.0.1.100) -> 阿里云ECS Instance (172.16.1.100)**

```bash
# 在AWS EC2上执行
ping 172.16.1.100
```

**预期输出**：
```
64 bytes from 172.16.1.100: icmp_seq=1 ttl=128 time=80.5 ms
64 bytes from 172.16.1.100: icmp_seq=2 ttl=128 time=82.1 ms
...
```

**预期延迟**：< 100ms

---

### 5.3 常见问题

#### Q1: VPN连接一直显示 "Pending" 或 "Down"

**A**：
1. 检查防火墙规则（AWS Security Group、阿里云安全组）
2. 检查路由表配置
3. 检查预共享密钥是否一致
4. 查看VPN日志（AWS CloudWatch、阿里云日志服务）

---

#### Q2: Ping不通，但VPN状态是 "Up"

**A**：
1. 检查源IP和目标IP是否在VPC的CIDR范围内
2. 检查路由表是否正确配置
3. 检查安全组是否允许ICMP流量
4. 检查主机防火墙

---

#### Q3: 延迟很高（> 200ms）

**A**：
1. 检查VPN网关的地域是否在相邻区域（如AWS us-east-1、阿里云 cn-hangzhou）
2. 检查带宽规格是否足够
3. 考虑使用专线连接（Direct Connect/物理专线）

---

## 六、输出与交付物

| 交付物 | 内容 |
|-------|------|
| AWS Customer Gateway | `yyc3-aliyun-cg` |
| AWS Virtual Private Gateway | `yyc3-vgw` |
| AWS VPN Connection | `yyc3-aliyun-vpn` |
| 阿里云VPN网关 | `yyc3-vpn-gateway` |
| 阿里云用户网关 | `yyc3-aws-cg` |
| 阿里云IPsec连接 | `yyc3-aws-ipsec` |
| 预共享密钥 | `YourSuperSecretP@ssw0rd123!` (保存到密码管理工具) |

---

## 七、参考文档

- [AWS Site-to-Site VPN文档](https://docs.aws.amazon.com/vpc/latest/userguide/vpn-connections.html)
- [阿里云VPN网关文档](https://help.aliyun.com/product/27769.html)

---

**文档版本**: v1.0.0
**最后更新**: 2026-01-04
**维护人**: YYC³ Infrastructure Team
